# Ultralytics ğŸš€ AGPL-3.0 License - https://ultralytics.com/license

# RT-DETR with MobileNetV4 + SEA + ASFF v2 (å®Œæ•´ä¸‰å°ºåº¦ASFF)
# 
# ğŸ¯ è®¾è®¡ç›®æ ‡ï¼ˆä¿®å¤v1å¤±è´¥ï¼‰ï¼š
#   âœ… ä½¿ç”¨å®Œæ•´ASFFï¼šP3/P4/P5éƒ½é‡‡ç”¨ä¸‰å±‚è‡ªé€‚åº”èåˆ
#   âœ… ä¿ç•™ä¼ ç»ŸUpsampleï¼šé¿å…DySampleç ´åç‰¹å¾å¯¹é½
#   âœ… å¢å¼ºèåˆæ·±åº¦ï¼šæ¢å¤å…³é”®è·¯å¾„çš„RepC3æ·±åº¦
#   âœ… ä¼˜åŒ–AIFIé€šé“ï¼šä½¿ç”¨896ï¼ˆ3.5xï¼‰è€Œé1024
#
# ğŸ“Š v1å¤±è´¥åŸå› åˆ†æï¼š
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ é—®é¢˜            â”‚ v1é…ç½®   â”‚ å½±å“     â”‚ v2ä¿®å¤   â”‚ é¢„æœŸ    â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ ASFFå¤ªç®€åŒ–      â”‚ ä»…P3å•å±‚ â”‚ -17.9%   â”‚ P3/P4/P5 â”‚ +5-8%   â”‚
# â”‚ DySampleä¸é€‚é…  â”‚ åŠ¨æ€é‡‡æ · â”‚ å¯¹é½å·®   â”‚ ä¼ ç»Ÿä¸Šé‡‡æ ·â”‚ ç¨³å®š    â”‚
# â”‚ èåˆæ·±åº¦ä¸è¶³    â”‚ RepC3Ã—2  â”‚ å®¹é‡ä½   â”‚ RepC3Ã—3  â”‚ æå‡    â”‚
# â”‚ AIFIè¿‡é«˜        â”‚ 1024     â”‚ è¿‡æ‹Ÿåˆï¼Ÿ â”‚ 896      â”‚ å¹³è¡¡    â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ğŸ”¥ v2æ ¸å¿ƒæ”¹è¿›ï¼š
#   1. å®Œæ•´ASFFï¼šä¸‰ä¸ªæ£€æµ‹å¤´éƒ½ä½¿ç”¨ASFFä¸‰å±‚èåˆï¼ˆæ¯å±‚å­¦ä¹ è‡ªé€‚åº”æƒé‡ï¼‰
#   2. ç¨³å®šä¸Šé‡‡æ ·ï¼šä½¿ç”¨nn.Upsampleæ›¿ä»£DySampleï¼ˆé¿å…å¯¹é½é—®é¢˜ï¼‰
#   3. å¢å¼ºèåˆï¼šFPN/PAN RepC3æ·±åº¦å¢åŠ åˆ°3å±‚
#   4. å¹³è¡¡AIFIï¼šé™ä½åˆ°896é€šé“ï¼ˆé¿å…è¿‡æ‹Ÿåˆï¼‰
#
# ğŸ“š å‚è€ƒï¼š
#   - ASFFåŸè®ºæ–‡åœ¨YOLOv3ä¸Šæå‡2-3% mAP
#   - ä¸‰å°ºåº¦ASFFæ˜¯æ ‡å‡†é…ç½®ï¼Œä¸åº”ç®€åŒ–
# Task docs: https://docs.ultralytics.com/tasks/detect

# Parameters
nc: 80  # number of classes
scales:  # model compound scaling constants
  m: [1.00, 1.00, 512]

backbone:
  # MobileNetV4 Hybrid Medium with SEA Attention (ä¿æŒä¸å˜)
  # Stage 0 - Stem
  - [-1, 1, Conv, [32, 3, 2]]  # 0-P1/2

  # Stage 1 - 320x320 -> 160x160  
  - [-1, 1, EdgeResidual, [48, 2, 4]]  # 1-P2/4

  # Stage 2 - 160x160 -> 80x80 (P3)
  - [-1, 1, UniversalInvertedResidual, [80, 2, 4, 5]]  # 2
  - [-1, 1, UniversalInvertedResidual, [80, 1, 2, 3]]  # 3
  - [-1, 1, Sea_Attention_Simplified, [80]]  # 4 - SEA

  # Stage 3 - 80x80 -> 40x40 (P4)
  - [-1, 1, UniversalInvertedResidual, [160, 2, 6, 5]]  # 5
  - [-1, 1, UniversalInvertedResidual, [160, 1, 2, 3]]  # 6
  - [-1, 1, UniversalInvertedResidual, [160, 1, 4, 3]]  # 7
  - [-1, 1, OptimizedSEA_Attention, [160]]  # 8 - SEA
  - [-1, 1, UniversalInvertedResidual, [160, 1, 4, 5]]  # 9
  - [-1, 1, C2f, [160]]  # 10
  - [-1, 1, UniversalInvertedResidual, [160, 1, 4, 3]]  # 11
  - [-1, 1, C2f, [160]]  # 12
  - [-1, 1, UniversalInvertedResidual, [160, 1, 4, 3]]  # 13
  - [-1, 1, OptimizedSEA_Attention, [160]]  # 14 - SEA
  - [-1, 1, C2f, [160]]  # 15

  # Stage 4 - 40x40 -> 20x20 (P5)
  - [-1, 1, UniversalInvertedResidual, [256, 2, 6, 5]]  # 16
  - [-1, 1, UniversalInvertedResidual, [256, 1, 4, 5]]  # 17
  - [-1, 1, TransformerEnhancedSEA, [256]]  # 18 - Transformer SEA
  - [-1, 2, UniversalInvertedResidual, [256, 1, 4, 5]]  # 19
  - [-1, 1, UniversalInvertedResidual, [256, 1, 2, 3]]  # 20
  - [-1, 1, UniversalInvertedResidual, [256, 1, 2, 5]]  # 21
  - [-1, 1, UniversalInvertedResidual, [256, 1, 2, 3]]  # 22
  - [-1, 1, UniversalInvertedResidual, [256, 1, 4, 3]]  # 23
  - [-1, 1, TransformerEnhancedSEA, [256]]  # 24 - Transformer SEA
  - [-1, 1, C2f, [256]]  # 25
  - [-1, 1, UniversalInvertedResidual, [256, 1, 4, 3]]  # 26

  # Final conv
  - [-1, 1, Conv, [960, 1, 1]]  # 27

head:
  # ğŸ”¥ å®Œæ•´ä¸‰å°ºåº¦ASFFèåˆæ¶æ„ v2
  # ä¿®å¤ï¼šä½¿ç”¨å®Œæ•´ASFF + ç¨³å®šUpsample + å¢å¼ºèåˆæ·±åº¦
  
  # ========== ç¬¬ä¸€æ®µï¼šé«˜å±‚ç‰¹å¾å¤„ç† (P5) ==========
  - [-1, 1, Conv, [256, 1, 1, None, 1, 1, False]]  # 28 input_proj.2
  - [-1, 1, AIFI, [896, 8]]  # 29 AIFIé™è‡³896ï¼ˆå¹³è¡¡æ€§èƒ½ä¸å‚æ•°ï¼‰
  - [-1, 1, Conv, [256, 1, 1]]  # 30 Y5, lateral_convs.0

  # ========== ç¬¬äºŒæ®µï¼šFPN ä¸Šé‡‡æ ·ï¼ˆP5 â†’ P4ï¼‰==========
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]  # 31 ä¼ ç»Ÿä¸Šé‡‡æ ·ï¼ˆç¨³å®šï¼‰
  - [15, 1, Conv, [256, 1, 1, None, 1, 1, False]]  # 32 input_proj.1
  - [[-2, -1], 1, Concat, [1]]  # 33 concat
  - [-1, 3, RepC3, [256]]  # 34 fpn_blocks.0 - å¢å¼ºåˆ°3å±‚
  - [-1, 1, Conv, [256, 1, 1]]  # 35 Y4, lateral_convs.1

  # ========== ç¬¬ä¸‰æ®µï¼šFPN ä¸Šé‡‡æ ·ï¼ˆP4 â†’ P3ï¼‰==========
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]  # 36 ä¼ ç»Ÿä¸Šé‡‡æ ·
  - [4, 1, Conv, [256, 1, 1, None, 1, 1, False]]  # 37 input_proj.0
  - [[-2, -1], 1, Concat, [1]]  # 38 concat
  - [-1, 3, RepC3, [256]]  # 39 fpn_blocks.1 - X3è¾“å‡ºï¼Œå¢å¼ºåˆ°3å±‚

  # ========== ç¬¬å››æ®µï¼šPAN ä¸‹é‡‡æ ·ï¼ˆP3 â†’ P4ï¼‰==========
  - [-1, 1, Conv, [256, 3, 2]]  # 40 downsample
  - [[-1, 35], 1, Concat, [1]]  # 41 concat with Y4
  - [-1, 3, RepC3, [256]]  # 42 pan_blocks.0 - F4è¾“å‡ºï¼Œ3å±‚

  # ========== ç¬¬äº”æ®µï¼šPAN ä¸‹é‡‡æ ·ï¼ˆP4 â†’ P5ï¼‰==========
  - [-1, 1, Conv, [256, 3, 2]]  # 43 downsample
  - [[-1, 30], 1, Concat, [1]]  # 44 concat with Y5
  - [-1, 3, RepC3, [256]]  # 45 pan_blocks.1 - F5è¾“å‡ºï¼Œ3å±‚

  # ========== ç¬¬å…­æ®µï¼šå®Œæ•´ä¸‰å°ºåº¦ASFFèåˆ ==========
  # æ¯ä¸ªå°ºåº¦éƒ½ä½¿ç”¨ASFFå­¦ä¹ ä¸‰å±‚ç‰¹å¾çš„è‡ªé€‚åº”èåˆæƒé‡
  
  # P3å¢å¼ºï¼šASFFèåˆ X3(P3), F4(P4), F5(P5)
  - [[39, 42, 45], 1, ASFF, [0, 256]]  # 46 ASFF for P3 (level=0)
  
  # P4å¢å¼ºï¼šASFFèåˆ X3(P3), F4(P4), F5(P5)
  - [[39, 42, 45], 1, ASFF, [1, 256]]  # 47 ASFF for P4 (level=1)
  
  # P5å¢å¼ºï¼šASFFèåˆ X3(P3), F4(P4), F5(P5)
  - [[39, 42, 45], 1, ASFF, [2, 256]]  # 48 ASFF for P5 (level=2)

  # ========== ç¬¬ä¸ƒæ®µï¼šæ£€æµ‹å¤´ ==========
  - [[46, 47, 48], 1, RTDETRDecoder, [nc]]  # 49 Detect(P3_asff, P4_asff, P5_asff)
