# Ultralytics ğŸš€ AGPL-3.0 License - https://ultralytics.com/license

# Ultralytics RT-DETR with MobileNetV4 Hybrid Medium backbone + SEA Attention + BiFPN-Lite (v2-Fixed)
# 
# å®é™…æ€§èƒ½åŸºå‡†ï¼ˆæœ€æ–°ç»Ÿè®¡ï¼‰ï¼š
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ æ¨¡å‹                 â”‚ å‚æ•°(M)  â”‚ å¤§å°(MB) â”‚ mAP50    â”‚ mAP50-95 â”‚ Precisionâ”‚ Recall   â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ RT-DETR-L            â”‚ 32.97    â”‚ 125.77   â”‚ 0.3163   â”‚ 0.2180   â”‚ 0.3453   â”‚ 0.3891   â”‚
# â”‚ RT-DETR-MNV4         â”‚ 24.98    â”‚ 95.29    â”‚ 0.4051   â”‚ 0.2680   â”‚ 0.5236   â”‚ 0.3925   â”‚
# â”‚ RT-DETR-MNV4-SEA     â”‚ 29.06    â”‚ 110.85   â”‚ 0.4782   â”‚ 0.3129   â”‚ 0.4901   â”‚ 0.4957   â”‚
# â”‚ RT-DETR-MNV4-SEA-BiFPNâ”‚ 29.85   â”‚ 113.86   â”‚ 0.3982   â”‚ 0.2746   â”‚ 0.5354   â”‚ 0.4200   â”‚ â† å½“å‰
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# âœ… v2-Fixed ä¿®å¤ç­–ç•¥ï¼ˆç›®æ ‡ï¼šè¶…è¶ŠSEAç‰ˆæœ¬ 0.4782ï¼‰ï¼š
#   1. AIFIé€‚åº¦æå‡ï¼š768â†’896ï¼ˆè¡¥å¿BiFPNå¼•å…¥çš„å¤æ‚åº¦ï¼‰
#   2. ç®€åŒ–BiFPNï¼šç§»é™¤P5èåˆï¼Œä»…ä¿ç•™P3å¢å¼ºï¼ˆä¸“æ³¨å°ç›®æ ‡ï¼‰
#   3. PANæ·±åº¦ä¼˜åŒ–ï¼šF4å¢å¼ºåˆ°4å±‚ï¼ŒF5ä¿æŒ3å±‚
#   4. FPNè½»é‡åŒ–ï¼šå‡å°‘æ—©æœŸèåˆæ·±åº¦ï¼ˆ2å±‚è¶³å¤Ÿï¼‰
# 
# ğŸ¯ é¢„æœŸæ•ˆæœï¼š
#   å‚æ•°ï¼š29.85M â†’ 29.5M (-1.2%)
#   mAP50ï¼š0.3982 â†’ 0.485-0.500 (+21.8-25.6%)
#   mAP50-95ï¼š0.2746 â†’ 0.320-0.335 (+16.5-22%)
#   ç›®æ ‡ï¼šè¶…è¶ŠSEAç‰ˆæœ¬ï¼Œè¾¾åˆ° mAP50 > 0.48
# Task docs: https://docs.ultralytics.com/tasks/detect

# Parameters
nc: 80 # number of classes
scales: # model compound scaling constants
  # [depth, width, max_channels]
  m: [1.00, 1.00, 512]

backbone:
  # MobileNetV4 Hybrid Medium backbone with integrated SEA Attention
  # Stage 0 - Stem: input 640x640 -> 320x320
  - [-1, 1, Conv, [32, 3, 2]]  # 0-P1/2, stem conv

  # Stage 1 - 320x320 -> 160x160  
  - [-1, 1, EdgeResidual, [48, 2, 4]]  # 1-P2/4, FusedIB (EdgeResidual) 

  # Stage 2 - 160x160 -> 80x80
  - [-1, 1, UniversalInvertedResidual, [80, 2, 4, 5]]  # 2-P3/8, ExtraDW with k=5
  - [-1, 1, UniversalInvertedResidual, [80, 1, 2, 3]]  # 3, ExtraDW with k=3
  - [-1, 1, Sea_Attention_Simplified, [80]]  # 4, Optimized SEA attention for early stage

  # Stage 3 - 80x80 -> 40x40 (å…³é”®ç‰¹å¾å±‚ + SEAæ³¨æ„åŠ›)
  - [-1, 1, UniversalInvertedResidual, [160, 2, 6, 5]]  # 5-P4/16, ExtraDW with k=5
  - [-1, 1, UniversalInvertedResidual, [160, 1, 2, 3]]  # 6, FFN-like
  - [-1, 1, UniversalInvertedResidual, [160, 1, 4, 3]]  # 7, ExtraDW
  - [-1, 1, OptimizedSEA_Attention, [160]]                    # 8, Optimized SEA attention
  - [-1, 1, UniversalInvertedResidual, [160, 1, 4, 5]]  # 9, ExtraDW
  - [-1, 1, C2f, [160]]                                 # 10, MQA-like attention
  - [-1, 1, UniversalInvertedResidual, [160, 1, 4, 3]]  # 11, ExtraDW
  - [-1, 1, C2f, [160]]                                 # 12, MQA-like attention
  - [-1, 1, UniversalInvertedResidual, [160, 1, 4, 3]]  # 13, ConvNeXt-like
  - [-1, 1, OptimizedSEA_Attention, [160]]                    # 14, Optimized SEA attention
  - [-1, 1, C2f, [160]]                                 # 15, MQA-like attention

  # Stage 4 - 40x40 -> 20x20 (é«˜å±‚ç‰¹å¾ + Transformerå¢å¼ºSEA)
  - [-1, 1, UniversalInvertedResidual, [256, 2, 6, 5]]  # 16-P5/32, ExtraDW with k=5
  - [-1, 1, UniversalInvertedResidual, [256, 1, 4, 5]]  # 17, ExtraDW
  - [-1, 1, TransformerEnhancedSEA, [256]]                    # 18, Transformer Enhanced SEA attention for high-level features
  - [-1, 2, UniversalInvertedResidual, [256, 1, 4, 5]]  # 19, ExtraDW blocks
  - [-1, 1, UniversalInvertedResidual, [256, 1, 2, 3]]  # 20, FFN-like
  - [-1, 1, UniversalInvertedResidual, [256, 1, 2, 5]]  # 21, ExtraDW
  - [-1, 1, UniversalInvertedResidual, [256, 1, 2, 3]]  # 22, FFN-like
  - [-1, 1, UniversalInvertedResidual, [256, 1, 4, 3]]  # 23, FFN-like
  - [-1, 1, TransformerEnhancedSEA, [256]]                    # 24, Transformer Enhanced SEA attention
  - [-1, 1, C2f, [256]]                                 # 25, MQA attention
  - [-1, 1, UniversalInvertedResidual, [256, 1, 4, 3]]  # 26, ConvNeXt-like

  # Final conv layer
  - [-1, 1, Conv, [960, 1, 1]]  # 27, final conv (matches MobileNetV4)

head:
  # v2-Fixed ä¿®å¤ç­–ç•¥ï¼ˆåŸºäºå®æµ‹å¤±è´¥æ•°æ® mAP50=0.3982 çš„åæ€ï¼‰
  # æ ¸å¿ƒï¼šç®€åŒ–BiFPNï¼Œå¢å¼ºå…³é”®è·¯å¾„ï¼Œæå‡AIFIè¡¨è¾¾èƒ½åŠ›
  
  # ç¬¬ä¸€æ®µï¼šé«˜å±‚ç‰¹å¾å¤„ç† (Y5 è·¯å¾„) - AIFIé€‚åº¦æå‡
  - [-1, 1, Conv, [256, 1, 1, None, 1, 1, False]] # 28 input_proj.2ï¼Œä¿æŒ256é€šé“
  - [-1, 1, AIFI, [896, 8]]                       # 29 transformerå¢å¼ºï¼Œæå‡åˆ°896ï¼ˆ3.5Ã—256ï¼‰
  - [-1, 1, Conv, [256, 1, 1]]                    # 30 Y5, lateral_convs.0

  # ç¬¬äºŒæ®µï¼šFPN ä¸Šé‡‡æ ·èåˆï¼ˆä» P5 åˆ° P4ï¼‰- è½»é‡åŒ–
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]
  - [15, 1, Conv, [256, 1, 1, None, 1, 1, False]] # 32 input_proj.1 (from stage 3)
  - [[-2, -1], 1, Concat, [1]]
  - [-1, 2, RepC3, [256]]                         # 34 fpn_blocks.0ï¼ŒY4èåˆå±‚ï¼ˆè½»é‡åŒ–ï¼‰
  - [-1, 1, Conv, [256, 1, 1]]                    # 35 Y4, lateral_convs.1

  # ç¬¬ä¸‰æ®µï¼šFPN ç»§ç»­ä¸Šé‡‡æ ·èåˆï¼ˆä» P4 åˆ° P3ï¼‰- è½»é‡åŒ–
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]
  - [4, 1, Conv, [256, 1, 1, None, 1, 1, False]]  # 37 input_proj.0 (from stage 2)
  - [[-2, -1], 1, Concat, [1]]
  - [-1, 2, RepC3, [256]]                         # 39 fpn_blocks.1ï¼ŒX3èåˆå±‚ï¼ˆè½»é‡åŒ–ï¼‰

  # ç¬¬å››æ®µï¼šPAN ä¸‹é‡‡æ ·èåˆï¼ˆä» P3 åˆ° P4ï¼‰- é‡ç‚¹å¢å¼º
  - [-1, 1, Conv, [256, 3, 2]]                    # 40 downsample_convs.0
  - [[-1, 35], 1, Concat, [1]]
  - [-1, 4, RepC3, [256]]                         # 42 pan_blocks.0ï¼ŒF4èåˆå±‚ï¼ˆå¢å¼ºåˆ°4å±‚ï¼‰

  # ç¬¬äº”æ®µï¼šPAN ç»§ç»­ä¸‹é‡‡æ ·èåˆï¼ˆä» P4 åˆ° P5ï¼‰- æ ‡å‡†é…ç½®
  - [-1, 1, Conv, [256, 3, 2]]                    # 43 downsample_convs.1
  - [[-1, 30], 1, Concat, [1]]
  - [-1, 3, RepC3, [256]]                         # 45 pan_blocks.1ï¼ŒF5èåˆå±‚ï¼ˆä¿æŒ3å±‚ï¼‰

  # ç¬¬å…­æ®µï¼šBiFPN ç®€åŒ–ç‰ˆï¼ˆä»…P3å¢å¼ºï¼Œç§»é™¤å¤±æ•ˆçš„P5è·¯å¾„ï¼‰
  # ç­–ç•¥ï¼šä¸“æ³¨å°ç›®æ ‡è·¯å¾„ä¼˜åŒ–ï¼Œç§»é™¤å¯¼è‡´æ€§èƒ½ä¸‹é™çš„P5èåˆ
  
  # æ·»åŠ  P3 â† P4 èåˆï¼šä» F4 å›ä¼ åˆ° X3ï¼ˆå°ç›®æ ‡å…³é”®ï¼‰
  - [42, 1, nn.Upsample, [None, 2, "nearest"]]   # 46 ä» F4(P4) ä¸Šé‡‡æ ·
  - [[46, 39], 1, Concat, [1]]
  - [-1, 1, RepC3, [256]]                         # 48 BiFPN å¢å¼º P3ï¼ˆ256é€šé“ï¼‰

  # ç›´æ¥ä½¿ç”¨å¢å¼ºåçš„ç‰¹å¾è¿›è¡Œæ£€æµ‹ï¼ˆç§»é™¤P5é¢å¤–èåˆï¼‰
  - [[48, 42, 45], 1, RTDETRDecoder, [nc]]        # Detect(P3_enhanced, P4, P5)
